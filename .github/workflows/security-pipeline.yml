name: ğŸ”’ Pipeline de Seguridad y Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  security-and-build:
    name: ğŸ›¡ï¸ AnÃ¡lisis de Seguridad y ConstrucciÃ³n
    runs-on: ubuntu-latest
    
    steps:
      # ==========================================
      # 1. PREPARACIÃ“N DEL ENTORNO
      # ==========================================
      - name: ğŸ“¥ Checkout del repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ Instalar dependencias
        run: |
          echo "ğŸ”§ Instalando paquetes npm..."
          npm ci
          echo "âœ… Dependencias instaladas correctamente"
      
      # ==========================================
      # 2. ANÃLISIS DE VULNERABILIDADES
      # ==========================================
      - name: ğŸ” AnÃ¡lisis de vulnerabilidades en dependencias (npm audit)
        id: npm-audit
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ” BUSCANDO VULNERABILIDADES EN DEPENDENCIAS       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          npm audit --audit-level=moderate || echo "âš ï¸ Vulnerabilidades encontradas"
          npm audit --json > npm-audit-report.json || true
          echo "âœ… AnÃ¡lisis npm audit completado"
        continue-on-error: true
      
      - name: ğŸ“Š Generar reporte de npm audit
        if: always()
        run: |
          echo "ğŸ“‹ Generando reporte legible..."
          if [ -f npm-audit-report.json ]; then
            echo "Vulnerabilidades encontradas:"
            cat npm-audit-report.json | jq '.vulnerabilities | length'
          fi
      
      # ==========================================
      # 3. ANÃLISIS ESTÃTICO DE CÃ“DIGO
      # ==========================================
      - name: ğŸ” ESLint - AnÃ¡lisis de cÃ³digo con reglas de seguridad
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ” ANALIZANDO CÃ“DIGO CON ESLINT                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          npm run lint || echo "âš ï¸ Problemas de linting encontrados"
          echo "âœ… AnÃ¡lisis estÃ¡tico completado"
        continue-on-error: true
      
      # ==========================================
      # 4. VERIFICACIÃ“N DE SECRETOS
      # ==========================================
      - name: ğŸ” Detectar secretos y contraseÃ±as en texto plano
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ” BUSCANDO SECRETOS EN EL CÃ“DIGO                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Buscar contraseÃ±as en archivos JSON
          if grep -r '"password".*:.*"[^"]*"' public/ src/assets/ 2>/dev/null; then
            echo "âŒ ERROR CRÃTICO: ContraseÃ±as en texto plano detectadas"
            echo "ğŸ”’ Esto es una vulnerabilidad de seguridad grave"
            exit 1
          fi
          
          echo "âœ… No se encontraron secretos expuestos"
      
      # ==========================================
      # 5. BUILD DEL PROYECTO
      # ==========================================
      - name: ğŸ—ï¸ Build de la aplicaciÃ³n Angular
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ—ï¸ CONSTRUYENDO APLICACIÃ“N                         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          npm run build -- --configuration production
          echo "âœ… Build completado exitosamente"
      
      # ==========================================
      # 6. TESTS UNITARIOS
      # ==========================================
      - name: ğŸ§ª Ejecutar tests unitarios
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ§ª EJECUTANDO TESTS                                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          npm run test -- --watch=false --browsers=ChromeHeadless
          echo "âœ… Tests completados"
      
      # ==========================================
      # 7. REPORTES Y ARTEFACTOS
      # ==========================================
      - name: ğŸ“Š Subir reportes de seguridad
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            npm-audit-report.json
            coverage/
          retention-days: 30
      
      - name: ğŸ“¦ Subir build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: golfkart-build
          path: dist/
          retention-days: 7
      
      # ==========================================
      # 8. RESUMEN FINAL
      # ==========================================
      - name: âœ… Resumen del pipeline
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              ğŸ“‹ RESUMEN DEL PIPELINE                         â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  âœ… InstalaciÃ³n de dependencias: OK                          â•‘"
          echo "â•‘  ğŸ” AnÃ¡lisis de vulnerabilidades: Completado                 â•‘"
          echo "â•‘  ğŸ” AnÃ¡lisis estÃ¡tico (ESLint): Completado                   â•‘"
          echo "â•‘  ğŸ” DetecciÃ³n de secretos: OK                                â•‘"
          echo "â•‘  ğŸ—ï¸ Build de producciÃ³n: OK                                  â•‘"
          echo "â•‘  ğŸ§ª Tests unitarios: OK                                      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ‰ Â¡Pipeline completado exitosamente!"
          echo "ğŸš€ El cÃ³digo estÃ¡ listo para deployment"
          echo ""
