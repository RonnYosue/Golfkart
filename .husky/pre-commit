#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  ğŸ” ANÃLISIS DE SEGURIDAD PRE-COMMIT                        â•‘"
echo "â•‘  Espera, voy a revisar los cambios antes de confirmarlos... â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "ğŸ“‹ Paso 1/3: Verificando formato del cÃ³digo..."
npx lint-staged
LINT_EXIT=$?

if [ $LINT_EXIT -ne 0 ]; then
  echo ""
  echo "âŒ ERROR: Problemas de formato detectados"
  echo "ğŸ’¡ Ejecuta 'npm run lint:fix' para corregir automÃ¡ticamente"
  exit 1
fi

echo "âœ… Formato correcto"
echo ""

echo "ğŸ“‹ Paso 2/3: Buscando vulnerabilidades en dependencias..."
npm audit --audit-level=high > /dev/null 2>&1
AUDIT_EXIT=$?

if [ $AUDIT_EXIT -ne 0 ]; then
  echo ""
  echo "âš ï¸  ADVERTENCIA: Se encontraron vulnerabilidades en las dependencias"
  echo "ğŸ’¡ Ejecuta 'npm audit' para ver detalles"
  echo "ğŸ’¡ Ejecuta 'npm audit fix' para intentar corregirlas"
  echo ""
fi

echo "âœ… AnÃ¡lisis de vulnerabilidades completado"
echo ""

echo "ğŸ“‹ Paso 3/3: Verificando reglas de seguridad en el cÃ³digo..."

# Verificar si hay contraseÃ±as en texto plano en archivos staged
STAGED_FILES=$(git diff --cached --name-only)
SECURITY_ISSUES=0

for file in $STAGED_FILES; do
  case "$file" in
    *.json)
      if [ -f "$file" ]; then
        if grep -q '"password"' "$file" 2>/dev/null; then
          echo "âš ï¸  ADVERTENCIA: Posible contraseÃ±a en texto plano detectada en: $file"
          SECURITY_ISSUES=$((SECURITY_ISSUES + 1))
        fi
      fi
      ;;
  esac
done

if [ $SECURITY_ISSUES -gt 0 ]; then
  echo ""
  echo "âŒ ERROR CRÃTICO: Se detectaron $SECURITY_ISSUES problema(s) de seguridad"
  echo "ğŸ”’ No se permite almacenar contraseÃ±as en texto plano"
  echo "ğŸ’¡ SoluciÃ³n: Implementa hash de contraseÃ±as o usa un backend seguro"
  echo ""
  exit 1
fi

echo "âœ… Sin problemas de seguridad detectados"
echo ""

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  âœ… VALIDACIÃ“N COMPLETADA EXITOSAMENTE                      â•‘"
echo "â•‘  Tu cÃ³digo estÃ¡ listo para ser confirmado                    â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
